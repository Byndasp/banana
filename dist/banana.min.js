Array.prototype.last=function(){return this[this.length-1]};Array.prototype.clear=function(){this.splice(0,this.length)};if(!isset(Array.prototype.forEach)){Array.prototype.forEach=function(a){for(var b=0;b<this.length;b++){a(this[b],b,this)}}}String.prototype.escapeHTML=function(){var a={"&":"&amp;","<":"&lt;",">":"&gt;"};return this.replace(/[&<>]/g,function(b){return a[b]||b})};String.prototype.cut=function(a){if(this.length>a){return this.substring(0,a-1)+"â€¦"}else{return this}};String.prototype.isEmpty=function(a){return a.trim().length==0};function isset(a){return typeof a!=="undefined"||a!==undefined}var Banana={version:"0.8",modules:{},debug:true,Tools:{add:function(b,a){this[b]=a;return this},GUID:function(){function a(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},DOM:{hasAttribute:function(c,b){if(c instanceof jQuery){c=c.get(0)}var a=c.getAttribute(b);return(typeof a!=typeof undefined&&a!=null)},isManaged:function(b,a){a=(a==true)?a=this.hasAttribute(b,"data-guid"):true;return this.hasAttribute(b,"data-controller")&&a},exists:function(a){return document.querySelectorAll(a).length>0},nodeExistsInDOM:function(a){return document.querySelectorAll("*[data-guid='"+a+"']").length>0}},Arrays:{forEach:function(a,b){for(var d=0;d<a.length;d++){b(a[d],d,this)}}},KeyCodes:{backSpace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capsLock:20,escape:27,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,del:46},Console:{print:function(e,d,b,c){if(typeof a=="undefined"){var a={log:function(){},error:function(){},warn:function(){}}}if(Banana.debug){if(isset(c)){a[e]("%c["+d+"] %c"+b,"color: #881391;","color:initial",c)}else{a[e]("%c["+d+"] %c"+b,"color: #881391;","color:initial")}}}},Factory:{findAppComponent:function(a,b,c){if(isset(c)&&isset(c[b][a])){return c[b][a]}else{if(isset(Banana.Global[b][a])){return Banana.Global[b][a]}else{throw new Error("Banana: App component '"+a+"' not found in "+b)}}},resourceExists:function(c,a,b){if(!isset(c)){return isset(Banana.Global[a][b])}return(isset(c[a][b])||isset(Banana.Global[a][b]))},inspectDependencies:function(a,d){var b=[];if(isset(a)){if(typeof a=="string"){a=[a]}for(var e=0;e<a.length;e++){if(this.resourceExists(d,"models",a[e])||this.resourceExists(d,"services",a[e])){b.push(a[e])}else{throw new Error("Banana: unsolvable dependency '"+a[e]+"'")}}}return b},createController:function(c,b,a,d){d.controllers[c]=new Banana.Controller(c,b,a,d)},createModel:function(a,d,b,c){c.models[a]=new Banana.Model(a,d,b,c)},createService:function(c,a,b,d){d.services[c]=new Banana.Service(c,a,b,d)}}},Global:{services:[],models:[],controllers:[],service:function(d,b,c,a){if(!isset(a)){a=false}Banana.Tools.Factory.createService(d,b,c,this);if(!a){return this}},controller:function(c,b,a){Banana.Tools.Factory.createController(c,b,a,this);return this},model:function(c,a,b){Banana.Tools.Factory.createModel(c,a,b,this);return this},require:function(b,a){if(typeof a=="undefined"){a=[]}if(typeof this[b]!="undefined"&&this[b] instanceof Array){a=a.concat(this[b])}return a}},Model:function(c,a,b,d){this.name=c;this.model=a;this.type="model";this.di=Banana.Tools.Factory.inspectDependencies(b,d)},Service:function(c,a,b,d){this.name=c;this.service=a;this.type="service";this.di=Banana.Tools.Factory.inspectDependencies(b,d)},Controller:function(c,b,a,d){this.name=c;this.controller=b;this.type="controller";this.di=Banana.Tools.Factory.inspectDependencies(a,d)},Dictionary:function(){this.get=function(a,b){if(isset(this[a])){return this[a]}if(isset(b)){return b}if(isset(UI)){Banana.warn("scope","Trying to get undefined value: '"+a+"'",scope)}return false};this.set=function(a,b){this[a]=b;return this[a]};this.push=function(b){for(var a in b){if(b.hasOwnProperty(a)){this[a]=b[a]}}}},Node:function(a,b){if(Banana.Tools.DOM.hasAttribute(a,"data-guid")){throw new Error("Node has been already binded to this element")}this.guid=Banana.Tools.GUID();this.module=undefined;this.element=(typeof a=="string")?document.querySelector(a):a;this.$=$(this.element);this.controllerName=(isset(b))?b:this.$.attr("data-controller");this.$.attr("data-guid",this.guid);this.controller=undefined;this.appendToTree=function(c){this.module=c;this.module.nodes[this.guid]=this;this.controller=c.getController(this.controllerName,this.guid)};this.getParentNode=function(){if(Banana.Tools.DOM.hasAttribute(this.element.parentElement,"data-controller")){return $(this.element.parentElement).node()}return $(this.element).parent("[data-controller]").node()};this.getChildren=function(){return $(this.element).children("[data-controller]").node()};this.getParentController=function(){return this.getParentNode().controller}},Module:function(element,bootstrap){var appInstance=this;this.selector=element.toString();if(typeof element=="string"){element=document.querySelector(element)}this.htmlElement=element;this.controllers={};this.models={};this.services={};this.started=false;this.events={};this.nodes={};this.scope=new Banana.Dictionary();this.on=function(eventName,eventFunc){if(!isset(this.events[eventName])){this.events[eventName]=[]}this.events[eventName].push(eventFunc)};this.trigger=function(eventName){if(isset(this.events[eventName])){this.events[eventName].forEach(function(ev){ev()})}};this.onLoad=function(){this.trigger("load")};this.onInit=function(){this.trigger("init")};this.bindElement=function(elem,controllerName){if(Banana.Tools.DOM.hasAttribute(elem,"data-guid")){return true}if(!isset(controllerName)){controllerName=$(elem).attr("data-controller")}return new Banana.Node(elem,controllerName).appendToTree(this)};function gc(){for(var c in appInstance.nodes){if(!Banana.Tools.DOM.nodeExistsInDOM(c)){delete appInstance.nodes[c]}}}this.init=function(target){var instance=this;if(!isset(target)){target=this.htmlElement}var elementsToLoad=Array.prototype.slice.call(target.querySelectorAll("*[data-controller]:not([data-guid])"));if(isset(target)&&Banana.Tools.DOM.isManaged(target)){elementsToLoad.push(target)}elementsToLoad.forEach(function(e){if(!Banana.Tools.DOM.hasAttribute(e,"data-guid")){instance.bindElement(e)}});if(this.started==false){$(this.htmlElement).on("DOMNodeInserted",function(ev){setTimeout(function(){gc();appInstance.init(ev.target)},100)}).on("DOMNodeRemoved",function(ev){setTimeout(function(){gc()},100)});this.started=true;this.onLoad()}};function injectDependencies(appComponent){var args="";for(var c=0;c<appComponent.di.length;c++){var pushed=false;if(Banana.Tools.Factory.resourceExists(appInstance,"models",appComponent.di[c])){args+="appInstance.model('"+appComponent.di[c]+"')";pushed=true}if(Banana.Tools.Factory.resourceExists(appInstance,"services",appComponent.di[c])){if(pushed){args+=", "}args+="appInstance.service('"+appComponent.di[c]+"')"}if(c<(appComponent.di.length-1)){args+=", "}}return args}this.getController=function(controllerName,bindElement){var ctrl=Banana.Tools.Factory.findAppComponent(controllerName,"controllers",appInstance);var args=injectDependencies(ctrl);if(isset(bindElement)){if(ctrl.di.length>0){args+=", "}args+="appInstance.htmlElement.querySelector(\"*[data-controller='"+controllerName+"'][data-guid='"+bindElement+"']\")"}return eval("new ctrl.controller("+args+")")};this.controller=function(controllerName,controllerBody,dependsOn,runImmediately){if(isset(controllerBody)){Banana.Tools.Factory.createController(controllerName,controllerBody,dependsOn,appInstance);if(isset(runImmediately)&&runImmediately==false){return this}}return appInstance.getController(controllerName)};this.getModel=function(modelName){var ctrl=Banana.Tools.Factory.findAppComponent(modelName,"models",appInstance);var args=injectDependencies(ctrl);return eval("new ctrl.model("+args+")")};this.model=function(mName,mBody,dependsOn){if(isset(mBody)){Banana.Tools.Factory.createModel(mName,mBody,dependsOn,appInstance);return this}return appInstance.getModel(mName)};this.getService=function(modelName){var ctrl=Banana.Tools.Factory.findAppComponent(modelName,"services",appInstance);var args=injectDependencies(ctrl);return eval("new ctrl.service("+args+")")};this.service=function(mName,mBody,dependsOn,returnObject){if(!isset(returnObject)){returnObject=false}if(isset(mBody)){Banana.Tools.Factory.createService(mName,mBody,dependsOn,appInstance);if(!returnObject){return this}}return appInstance.getService(mName)};if(isset(bootstrap)){bootstrap(this)}},require:function(a,b){if(typeof b=="undefined"){b=this}b[a]=this.Tools[a]},panic:function(b,c,a){this.print("error",b,c,a)},info:function(b,c,a){this.print("info",b,c,a)},warn:function(b,c,a){this.print("warn",b,c,a)},log:function(b,c,a){this.print("log",b,c,a)},createModule:function(c,a,d){var b=undefined;if(isset(a)){switch(typeof a){case"function":d=a;a="*[data-banana='"+c+"']";break;case"object":if(a instanceof jQuery){a=a.get(0)}if(a instanceof HTMLElement){b=a;if(a.id.length==0){a.id=Banana.Tools.GUID()}a="#"+a.id}else{throw new Error("Banana: cannot create module, 'nodeSelector' is not an HTML node")}break}}else{a="*[data-banana='"+c+"']"}if(!isset(b)){b=document.querySelector(a)}if(b==null){throw new Error("Banana: cannot create module '"+c+"', root DOM element with selector '"+a+"' doesn't exists")}this.modules[c]={name:c,node:b,module:new Banana.Module(a,d)};return this.modules[c]},module:function(b,a,c){Banana.createModule(b,a,c);return Banana.modules[b].module}};if(typeof jQuery!=="undefined"){jQuery.fn.hidden=function(){this.addClass("hide");return this};jQuery.fn.shown=function(){this.removeClass("hide");return this};jQuery.fn.toggle=function(){this.hasClass("hide")?this.shown():this.hidden();return this};jQuery.fn.isHidden=function(){return this.hasClass("hide")};jQuery.fn.hasChildren=function(){return this.children().length<0};jQuery.fn.guid=function(){return this.attr("data-guid")};jQuery.fn.node=function(){var a=this.guid();if(!isset(app.nodes[a])){Banana.warn("banana","Element has no virtual node in app")}return app.nodes[a]};jQuery.fn.controller=function(){var a=this.node();if(!isset(a)){return undefined}return a.controller}}Banana.Global.service("eventProvider",function(){var c=undefined,a=this,b=[];this.bind=function(d){d.on=a.on;d.trigger=a.trigger;c=d};this.setHandler=function(d){c=d;return a};this.on=function(d,e){if(!isset(b[d])){b[d]=[]}b[d].push(e);return a};this.trigger=function(e,f){if(!isset(b[e])){return true}for(var g=0;g<b[e].length;g++){var d=b[e][g];if(isset(f)){return d(f,c,e)}d(c,e)}}});